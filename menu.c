/*
 * menu.c
 *
 *  Created on: 6 nov. 2023
 *      Author: Ray
 */
#include "menu.h"
#include <stdlib.h>

uint8_t flip = 0;

uint8_t x_pill = 0;
uint8_t y_pill = 0;

uint8_t left = 0;
uint8_t right = 0;
uint8_t up = 0;
uint8_t down = 0;

const uint8_t white_up[] 	= {0xFF,0x81,0x81,0x81,0x81,0x81,0x66,0x18};
const uint8_t black_up[] 	= {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x7E,0x18};
const uint8_t line_up[]  	= {0x99,0x99,0x99,0x99,0x99,0x99,0x7E,0x18};

const uint8_t white_down[] 	= {0x18,0x66,0x81,0x81,0x81,0x81,0x81,0xFF};
const uint8_t black_down[] 	= {0x18,0x7E,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF};
const uint8_t line_down[]  	= {0x18,0x7E,0x99,0x99,0x99,0x99,0x99,0x99};

const uint8_t white_l[] = {0xFC,0x82,0x82,0x81,0x81,0x82,0x82,0xFC};
const uint8_t black_l[] = {0xFC,0xFE,0xFE,0xFF,0xFF,0xFE,0xFE,0xFC};
const uint8_t line_l[]  = {0xFC,0x82,0x82,0xFF,0xFF,0x82,0x82,0xFC};

const uint8_t white_r[] = {0x3F,0x41,0x41,0x81,0x81,0x41,0x41,0x3F};
const uint8_t black_r[] = {0x3F,0x7F,0x7F,0xFF,0xFF,0x7F,0x7F,0x3F};
const uint8_t line_r[]  = {0x3F,0x41,0x41,0xFF,0xFF,0x41,0x41,0x3F};

const uint8_t white_v[] = {0x18,0x66,0x42,0x81,0x81,0x42,0x66,0x18};
const uint8_t black_v[] = {0x18,0x7E,0x7E,0xFF,0xFF,0x7E,0x7E,0x18};
const uint8_t line_v[]  = {0x18,0x66,0x42,0xFF,0xFF,0x42,0x66,0x18};

const uint8_t BASE_GAME[504] = {
		0xFF,0x01,0x01,0xF1,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0xF1,0x01,0x01,0XFF,0X00,0X00,0X80,0X80,
		0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0XFF,0X80,0X80,0X8F,0X88,0X88,0XFF,0X00,
		0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0XFF,0X01,0X01,0xF1,0X11,0X11,0XFF,0X00,
		0xFF,0X80,0X80,0x8F,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x8F,0x80,0x80,0XFF,0X00,0x00,0x01,0x01,
		};
uint8_t CURRENT_GAME[504] = {
		0xFF,0x01,0x01,0xF1,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0xF1,0x01,0x01,0XFF,0X00,0X00,0X80,0X80,
		0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0XFF,0X80,0X80,0X8F,0X88,0X88,0XFF,0X00,
		0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0XFF,0X01,0X01,0xF1,0X11,0X11,0XFF,0X00,
		0xFF,0X80,0X80,0x8F,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x8F,0x80,0x80,0XFF,0X00,0x00,0x01,0x01,
		};
uint8_t CHECK_PILLS[36] = {
		0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,
		};
void MENU_init(void){
	LCD_nokia_init();
	LCD_nokia_clear();
	LCD_nokia_bitmap(BASE_GAME);
	MENU_add_virus();
	LCD_nokia_bitmap(CURRENT_GAME);

}
void MENU_add_virus(void){

	static uint8_t x = 3;
	static uint8_t y = 5;
	static uint32_t here = 0;
	for(uint8_t i = 0; i != 8; i++){
		here = (((84*x)+4)+(8*(y-1)))+i;
		CURRENT_GAME[here] = white_v[i];
	}
}
void MENU_add_pill(void){
	static uint32_t left_position = 0;
	static uint32_t right_position = 0;

	x_pill = 2;
	y_pill = 10;

	left_position = (((84*x_pill)+4)+(8*(y_pill-1)));
	right_position = (((84*(x_pill+1))+4)+(8*(y_pill-1)));

	left = 	rand() & ~(0xfffffff0);//PIT_GetCurrentTimerCount(PIT, kPIT_Chnl_0) & ~(0xfffffffc);
	right =	rand() & ~(0xfffffff0);//PIT_GetCurrentTimerCount(PIT, kPIT_Chnl_0) & ~(0xfffffffc);

	for(uint8_t i = 0; i != 8; i++){

		if(CURRENT_GAME[left_position] != 0x00 && i == 0){
			MENU_game_reset();
		}

		MENU_add_left(left_position, left, i);
		MENU_add_right(right_position, right, i);

		left_position++;
		right_position++;
	}
}
void MENU_down_pill(void){
	y_pill--;

	static uint32_t left_position = 0;
	static uint32_t right_position = 0;
	static uint32_t last_left_position = 0;
	static uint32_t last_right_position = 0;

	left_position = (((84*x_pill)+4)+(8*(y_pill-1)));
	right_position = (((84*(x_pill+1))+4)+(8*(y_pill-1)));
	last_left_position = (((84*x_pill)+4)+(8*(y_pill)));
	last_right_position = (((84*(x_pill+1))+4)+(8*(y_pill)));

	for(uint8_t i = 0; i != 8; i++){

		if((CURRENT_GAME[left_position] != 0x00 || CURRENT_GAME[right_position] != 0x00 || y_pill  == 0) && i == 0){
			MENU_add_pill();
			break;
		}
		MENU_add_left(left_position, left, i);
		MENU_add_right(right_position, right, i);

		MENU_clean_pill(last_left_position);
		MENU_clean_pill(last_right_position);

		left_position++;
		right_position++;
		last_left_position++;
		last_right_position++;
	}
	LCD_nokia_bitmap(CURRENT_GAME);

}
void MENU_game_reset(void){
	for(uint32_t i = 0; i != 504; i++){
		CURRENT_GAME[i] = BASE_GAME[i];
	}
}
void MENU_move_left(void){
	x_pill--;
	static uint32_t left_position = 0;
	static uint32_t right_position = 0;
	static uint32_t last_right_position = 0;

	left_position = (((84*x_pill)+4)+(8*(y_pill-1)));
	right_position = (((84*(x_pill+1))+4)+(8*(y_pill-1)));
	last_right_position = (((84*(x_pill+2))+4)+(8*(y_pill-1)));

	for(uint8_t i = 0; i != 8; i++){
		if(CURRENT_GAME[left_position] != 0x00 && i == 0){
			x_pill++;
			break;
		}
		MENU_add_left(left_position, left, i);
		MENU_add_right(right_position, right, i);

		MENU_clean_pill(last_right_position);

		left_position++;
		right_position++;
		last_right_position++;

	}
	LCD_nokia_bitmap(CURRENT_GAME);
}
void MENU_move_right(void){
	x_pill++;
	static uint32_t left_position = 0;
	static uint32_t right_position = 0;
	static uint32_t last_left_position = 0;

	left_position = (((84*x_pill)+4)+(8*(y_pill-1)));
	right_position = (((84*(x_pill+1))+4)+(8*(y_pill-1)));
	last_left_position = (((84*(x_pill-1))+4)+(8*(y_pill-1)));

	for(uint8_t i = 0; i != 8; i++){
		if(CURRENT_GAME[right_position] != 0x00 && i == 0){
			x_pill--;
			break;
		}
		MENU_add_left(left_position, left, i);
		MENU_add_right(right_position, right, i);

		MENU_clean_pill(last_left_position);

		left_position++;
		right_position++;
		last_left_position++;

	}
	LCD_nokia_bitmap(CURRENT_GAME);
}

void MENU_add_left(uint32_t position, uint8_t pill,uint8_t part){
	if (pill >= 6){
		CURRENT_GAME[position] = white_l[part];
	}else if (pill >= 3){
		CURRENT_GAME[position] = black_l[part];
	}else{
		CURRENT_GAME[position] = line_l[part];
	}
}

void MENU_add_right(uint32_t position, uint8_t pill,uint8_t part){
	if (pill >= 6){
		CURRENT_GAME[position] = white_r[part];
	}else if (pill >= 3){
		CURRENT_GAME[position] = black_r[part];
	}else{
		CURRENT_GAME[position] = line_r[part];
	}
}
void MENU_add_up(uint32_t position, uint8_t pill,uint8_t part){
	if (pill >= 6){
		CURRENT_GAME[position] = white_up[part];
	}else if (pill >= 3){
		CURRENT_GAME[position] = black_up[part];
	}else{
		CURRENT_GAME[position] = line_up[part];
	}
}
void MENU_add_down(uint32_t position, uint8_t pill,uint8_t part){
	if (pill >= 6){
		CURRENT_GAME[position] = white_down[part];
	}else if (pill >= 3){
		CURRENT_GAME[position] = black_down[part];
	}else{
		CURRENT_GAME[position] = line_down[part];
	}
}
void MENU_clean_pill(uint32_t position){
	CURRENT_GAME[position] = 0x00;
}
